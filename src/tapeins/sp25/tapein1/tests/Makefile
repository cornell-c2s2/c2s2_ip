#HDL Language (always Verilog)
TOPLEVEL_LANG ?= verilog

#RTL Simulator (always Synopsys VCS)
SIM := vcs

#Sets location for sim_build directory depending on if tests are run with the Makefile or with the bash script
ifneq ($(TESTSUFFIX),)
	TEST_DIR = obj_dir/$(TESTNAME)/$(TESTSUFFIX)
else
	TEST_DIR = obj_dir/individual/$(TESTNAME)
endif

ifneq ($(TESTNAME),)
	SIM_BUILD = $(TEST_DIR)/sim_build
else
	SIM_BUILD = sim_build
endif

COCOTB_RESULTS_FILE = logs/$(TESTNAME)/$(TESTSUFFIX)/results.xml

#Add working directory to the Python virtual environment path
PWD=$(shell pwd)
C2S2_PATH=$(shell git rev-parse --show-toplevel)


export PYTHONPATH := $(PWD):$(PYTHONPATH)
WAVEFORM_DIR ?= $(PWD)

#Note: If working with functional models, make sure to UNCOMMENT the following line:

#export PYTHONPATH := $(PWD)/../models:$(PYTHONPATH)

#Adding relative path of the Verilog file that contains the top level module to VERILOG_SOURCES
# VERILOG_SOURCES ?= $(PWD)/$(SOURCE)
VERILOG_SOURCES += $(PWD)/../tapein1_sp25_top.v

#Step 1: Add all include directories referenced in the verilog source file
COMPILE_ARGS += +incdir+$(C2S2_PATH)/src -assert svaext
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/spi -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/arbiter_router -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/fft/pease/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/serdes/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/classifier/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/wishbone/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/lbist/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/async_fifo/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/crossbars/ -type f \( -name "*.v" -o -name "*.sv" \))
# VERILOG_SOURCES += $(shell find $(C2S2_PATH)/src/cmn/ -type f \( -name "*.v" -o -name "*.sv" \))



#Step 2: Add all include directories referenced in the verilog source file
COMPILE_ARGS += +incdir+$(C2S2_PATH)/src
COMPILE_ARGS += -sverilog


#Step 3: Set top level module and corresponding python test module
TOPLEVEL = tapein1_sp25_top
MODULE = test_top

#Step 4: Set environment variables for waveforms and coverage data to 1 if you  \
would like either waveforms or coverage data to be produced by the simulation. You can \
also set enviroment variables for model parameters and configure them in the simulation with \
the next step.
WAVES = 1
COVER = 1

#Step 5: Set model parameters by appending them to EXTRA_ARGS (if neccessary)\
#Examples (from multiplier example): \
EXTRA_ARGS += -pvalue+fixed_point_iterative_Multiplier.n=$N \
EXTRA_ARGS += -pvalue+fixed_point_iterative_Multiplier.d=$D

#Generating waveform files (Set environment variable WAVES to 1)
#Resulting waveform will be called waves.vcd and will be in the working directory
WAVES ?= 0
ifeq ($(WAVES), 1)
	EXTRA_ARGS += +vcs+dumpvars+waves.vcd
	EXTRA_ARGS += +vcs+vcdpluson
	EXTRA_ARGS += +vcs+vcdplusmemon
endif

#Generating line and toggle coverage data (Set environment variable COVER to 1)
COVER ?= 0
ifeq ($(COVER), 1)
	COMPILE_ARGS += -cm line+tgl
	SIM_ARGS += -cm line+tgl
endif

include $(shell cocotb-config --makefiles)/Makefile.sim

#Removing all files generated by a simulation
clean::
	rm -rf waves
	rm -rf coverage
	rm -rf logs
	rm -rf obj_dir
	rm -rf sim_build

#Generate a coverage report after running a simulation
coverage_report:
	@urg -dir $(shell find obj_dir -type d -name "*.vdb") -merge_strict -dbname coverage_data -noreport -warn none > /dev/null
	@urg -dir coverage_data.vdb -format both -report ./coverage
	@rm -rf coverage_data.vdb

# NOTE: temporary to get coverage report to generate
coverage_report_temp:
	urg -dir ./sim_build/simv.vdb -format both -report ./coverage_report